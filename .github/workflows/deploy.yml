name: Deploy MERN App

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõéÔ∏è Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build and push frontend images
        uses: docker/build-push-action@v5
        with:
          context: ./frondend
          file: ./frondend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ecomm-frontend:latest
          build-args: |
            VITE_PRODUCT_API=${{ secrets.VITE_PRODUCT_API }}

      - name: üèóÔ∏è Build and push backend images
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ecomm-backend:latest
        env:
          CLOUD_API_KEY: ${{ secrets.CLOUD_API_KEY }}
          CLOUD_API_SECRET: ${{ secrets.CLOUD_API_SECRET }}
          CLOUD_NAME: ${{ secrets.CLOUD_NAME }}
          MONGO_URL: ${{ secrets.MONGO_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          SAMPLE_IMAGE_URL: ${{ secrets.SAMPLE_IMAGE_URL }}
          SAMPLE_PUBLIC_ID: ${{ secrets.SAMPLE_PUBLIC_ID }}

      - name: üõ≥Ô∏è Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.SSH_USER }}/e-commerce-website
            git pull origin master
            docker compose down
            docker compose pull
            docker compose up -d --build
